# csv2kml-qc

This repository contains a basic python script to convert a .csv file generated by a **[GEOSTIX](https://www.geobsys.com/)** to .kml format for fast viewing on a map and quick quality checking (**qc**).

## Table of Contents

- [Description](#description)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)

# Description

# Prerequisites
Some tools need to be present on your system to run **csv2kml-qc** properly :
- **[Git](https://git-scm.com/)**
- **[Python](https://www.python.org/)**
- **[simplekml](https://simplekml.readthedocs.io/)**
- **[pyproj](https://pyproj4.github.io/pyproj/stable/)**
- **[shapely](https://shapely.readthedocs.io/en/stable/)**
- **[numpy](https://numpy.org/install/)**
- **[pandas](https://pandas.pydata.org/docs/getting_started/install.html)**
- **[os](https://docs.python.org/fr/3/library/os.html)**
- **[fiona](https://pypi.org/project/fiona/)**
- **[argparse](https://pypi.org/project/argparse/)**
- **[re](https://pypi.org/project/regex/)**
- **[gpsdatetime](https://pypi.org/project/gpsdatetime/)**
- **[gnsstoolbox](https://pypi.org/project/gnsstoolbox/)**

# Installation
Under Linux (Ubuntu) distribution the installation procedure is as follows:

1. Open a terminal
2. Installing dependencies:
    ```bash
    sudo apt-get install git python3.10
    ```
3. Clone **csv2kml-qc** repository:
    ```bash
    git clone git@github.com:Geobsys/csv2kml-qc.git
    ```
4. Create a virtual environment:
    ```bash
    python3.10 -m venv venv_csv2kml-qc
    ```
5. Activate the virtual environment:
    ```bash
    source venv_csv2kml-qc/bin/activate
    ```
6. Install modules:
   - **simplekml** module:
    ```bash
    pip install simplekml 
    ```
   - **pyproj** module:
    ```bash
    pip install pyproj
    ```
   - **shapely** module:
    ```bash
    pip install shapely
    ```
   - **os** module:
    ```bash
    pip install os
    ```
   - **numpy** module:
    ```bash
    pip install numpy
    ```
   - **pandas** module:
    ```bash
    pip install pandas
    ```
   - **fiona** module:
    ```bash
    pip install fiona
    ```
   - **argparse** module:
    ```bash
    pip install argparse
    ```
   - **re** module:
    ```bash
    pip install regex
    ```
   - **gpsdatetime** module:
    ```bash
    pip install gpsdatetime
    ```
   - **gnsstoolbox** module:
    ```bash
    pip install gnsstoolbox
    ```

# Usage
To test **csv2kml-qc**:
1. Access the main folder:
    ```bash
    cd csv2kml-qc
    ```
2. Launch the tool with the default setting on the dataset example:
    ```bash
    python3.10 src/csv_to_kml.py test/EXTENVENT.LOG
    ```
    EXTENVENT.LOG is one of the enter files.

3. Parameters 
   - **import parameters**:
     Define the format of the import file in the enter of the programm.

|Command | Name | Type | Description | Default value | Choices value |
|-----------|----------------|--------|--------------------------------------------------|---------------|-----------------------|
| -it       | input file     | string | input file type between 'extevent' and 'log'    | "extevent"   | ["extevent", "log"]   |
| -sep      | separator      | string | separator used in the .csv file                  | ","           |                       |


   - **export parameters**:
     Define the format of the export file in the end of the programm. 

| Command | Name | Type | Description | Default value | 
|----|----|----|----|----|
|   -o   |   output file   |   string |   output file in .kml format | "" |  
|   -name   |   doc_name  |   string |   kml document name |   ""  |  
|   --quiet   |     |    |   print some statistics |     |
   - **apearance parameters**:
     User can choose the representation of the point (mode, label and icon size in the kml)

|   Command   |   Name |  Type  |  Description |   Default value    | Choice value |
|----|----|----|----|----|----|
|   -m   |   mode   |   string |   representation mode | "icon" | ["icon"] |
|   -ls   |   label_scale  |   float |   label scale let you modify the size of the label |   2  |  |
|   -is   |   icon_scale  |   float |   icon scale let you modify the size of the icon |   1  |  |
|   -ih   |   icon_href   |   string |   marker in the kml | [icon](http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png) |  |
|   --show_pt_name   |     |  action="store_true"  |   Hide the points names |     |
   - **general parameters**:
     User can modify the number of data and the altitude in the representation of the object (relitveground or absolute).

|   Command   |   Name |  Type  |  Description |   Default value    | Choice value |
|----|----|----|----|----|----|
|   -dr   |   data_range   |   string |   Range of data from start (s), to end (e), with a step (t) : (s,e,t). e and t are optionnal. This allow you to decimate the number of the point | "extevent" | ["extevent", "log"] |
|   -am   |   altitude mode  |   string |   See simplekml .Altitudemode (absolute, relativeToGround, clampToGround). This define the mode of the altitude's representation |   "absolute"  | ["absolute", "relativeToGround", "clampToGround"] |
   - **Point**:
     User can choose to show to visualize or not the points.

|   Command   |   Action |   Description | 
|----|----|----|
|--show_point | action="store_false" | "Don't show points" |
   - **Line**:
     User can choose to show to visualize or not the lines.

|   Command   |   Action |   Description | 
|----|----|----|
|--show_line | action="store_false" | "Don't show the lines between the points" |
   - **Confidence interval**:
     User can choose to visualize or not the confidence intervals. There are represent as 3D pyramids. He can also choose a scale factor for planimetric and altimetric uncertainty. If there are too big uncertaintyn he can add a maximum value for them. 

|   Command   |   Name |  Type  |  Description |   Default value    | 
|----|----|----|----|----|
|   --show_conf_int   |      | action="store_false" |   Don't show the confidence interval |  |  
|   -sp   |   scale_factor_pla  | float |   Scale factor for planimetric uncertainty. |  1  |  
|   -mp   |  incert_pla_max   |  float  |   Maximum planimetric uncertainty |  np.nan   |
|   -sh   |  scale_factor_hig   |  float  |   Scale factor for altimetric uncertainty. |  1   |
|   -mh   |  incert_hig_max   |  float  |   Maximum altimetric uncertainty |  np.nan   |
   - **Buildings**:
     If the user wants, he can create a 3D model for the buildings in the study aera by adding a shapefile of the aera. 

|   Command   |   Name |  Type  |  Description |   Default value    | Condition |
|----|----|----|----|----|----|
|   -departments   |   departments   |   string |  Input folder where shp building file is stocked, or directly the file path. Warning, if there is others file in the folder, the programm will chose the first one by alphabet to define the schema, and then look to the others for the intersection if the both schema match. The user have to choose and download himself the right shapefile on [BD-TOPO](https://geoservices.ign.fr/documentation/donnees/vecteur/bdtopo) which correspond to his study area | "" |  |
|   --show_buildings   |     |   action="store_false" |   Don't show the show_buildings |    | Used only if there is a shapefile in enter |
|   -margin   |   margin  |   float |   margin (in geographical degres) around the workfield for building modelisation  |   0.001  | Used only if there is a shapefile in enter |
|   --save_buildings   |     |  action="store_true"  |   If you want to save the shp file of your buildings, you can provide a folder path and name. If the name is 'intersection', it will not be saved. |     |Used only if there is a shapefile in enter |
   - **Ephemerids**:
     If you want to know the number of satellite seen by a point at its acquisition date, you can add a rinex file which correspond at the right date. 

|   Command   |   Name |  Type  |  Description |   Default value    | 
|----|----|----|----|----|
|   --calc_ephemerids   |      | action="store_false" |   Don't calculate the ephemerids |  |  
|   -rn   |   rinex_name  | string |   Path of the observation or navigation rinex file |  ""  |  

   - **Frustum**:
     If you want to creat the frustum of the picture. These allow you to visualize the orientation of the sensors when taking a photo

|   Command   |   Name |  Type  |  Description |   Default value    | 
|----|----|----|----|----|
|   --show_orientation   |      | action="store_false" |   Don't show frustum |  |  
|   -fr_captor   |   frustum captor  | float |   distance factor of the near face of the frustum |  1  | 
|   -fr_focal   |   frustum focal  | float |   focal distance |  10  | 
|   -fr_distance   |   frustum distance  | float |   distance between the near plane et the far plane |  5  | 
|   -fr_alpha   |  alpha angle (frustum)  | float |   angle between camera reference frame and geographical reference frame aroud 'x' axe |  0  | 
|   -fr_beta   |   beta angle (frustum)  | float |   angle between camera reference frame and geographical reference frame around 'y'|  0  | 
|   -fr_gamme   |   gamma angle (frustum)  | float |   angle between camera reference frame and geographical reference frame around 'z' axe |  0  | 

3. Open the file **XXX.kml** on **[Google Earth](https://earth.google.com/)** viewer, you can decide to show the buildings, the traces, the points and the measured intervals through the top left window. 
By clicking on a point, you can see all its characteristics.
