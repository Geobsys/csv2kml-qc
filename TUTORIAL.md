# csv2kml-qc

This repository contains a basic python script to convert a .csv file generated by a **[GEOSTIX](https://www.geobsys.com/)** to .kml format for fast viewing on a map and quick quality checking (**qc**).

## Table of Contents

- [Introduction](#Introduction)
- [Uncertainties](#Uncertainties)
- [Frustums](#Frustums)
- [Buildings](#Buildings)
- [Ephemerids](#Ephemerids)
- [Help](#Help)


# Introduction

The module can produce a KML file from a CSV, and eventually with Shapefiles and RINEX files. The KML will be next visible in a software like [Google Earth](https://www.google.fr/intl/fr/earth/index.html).

You need to download the code and install all the required packages folowing the README.

After the installation, you need to prepare the files you will need :

- A CSV file, either of type "extevent" or "log" (see README.md). One of each is included in the repository.
- For displaying buildings, one or more Shapefiles from the [BD-TOPO](https://geoservices.ign.fr/bdtopo) covering the study area.
- For computing ephemerides, observation and navigation RINEX files.

## First exemple

1. Now you can launch a terminal and go to the application folder :
    ```bash
    cd csv2kml-qc
    ```

2. And start the first execution :
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent
    ```

Your first kml is saved as test/EXTEVENT.kml.

The parameter '-it' permite to specify the CSV type input, by changing it to 'log', you can process on "20240223.LOG" CSV file :
```bash
python src/csv_to_kml.py test/20240323.LOG -it 'log'
```

**Note : if you are using your own CSV file, you can specify the separator character with '-sep'**

3. The output file path can be specified with '-o' :
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -o test/output.kml
    ```
    And you can change the document name (the one who appear on Google Earth) with '-name' :
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -name output
    ```
    
## Process parameters

1. The program displays its progress by default. If you want to hide the output, use the '--quiet' option.

2. 'log' files can contain too many recorded points, which lengthens processing and creates slowdowns when displaying in a viewer. Therefore, you can choose to reduce the number of points using '-dr'. To do this, provide the first point to keep **s** (1st = 0), the last one **e** (-1), and the step between two retained points **t**. 
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -dr "(s,e,t)"
    ```

**Note : the data range option also allows you to exclude the first and last points.**

**By default, the data range is (0,-1,100).**


# Uncertainties

You may have noticed that the program by default displays uncertainty intervals.

1. Changing the uncertainty scale factor : 
    
    By default, the intervals are displayed to scale, but you can modify this by providing 1 or 2 parameters. 
    The first one ('-sp') allows you to modify the planimetric scale factor, and the second one ('-sh') for the altimetric scale.
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -sp 2 -sh 0.5
    ```
    
2. Determining maximum amplitudes: 
    
    Some intervals can be excessive, so you can set a maximum threshold (in meters) on both the planimetric and altimetric components with '-mp' and '-mh'.
    ```bash
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -mp 2 -mh 1
    ```

**Note : if you want to avoid the uncerterties generation, use '--show_conf_int'**

# Frustums

The 'extevent' mode is designed for photogrammetry. With each measurement, an orientation of the device is associated, which allows us to draw a frustum representing the image capture.

1. Changing the initial orientation of the camera: 
    
    The orientation depends on 3 angles '-fr_alpha', '-fr_beta', and '-fr_gamma', representing the rotations around the East, North, and Up (Altitude) axes, respectively. By default, the camera is considered aligned with the local Lambert 93 coordinate system, i.e., (0,0,0), but you can define the 3 angles in radians :
    ```bash 
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -fr_alpha 1 -fr_beta 0 -fr_gamma 0
    ```
    
2. Changing the frustum shape: 

    By modifying the parameter '-fr_sensor', you define the size of the sensor, '-fr_focal' modifies the focal distance, and '-fr_distance' the distance between the point and the base of the frustum :
    ```bash 
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -fr_sensor 2 -fr_focal 5 -fr_distance 20
    ```

# Buildings

The program also allows integrating buildings present in the study area. This step requires providing a Shapefile (.shp) from the [BD-TOPO](https://geoservices.ign.fr/bdtopo) post-2024 dataset (previous dates do not follow the same format.)

1. By using the command '-departments', you provide the program with the location of the .shp file to use :
    ```bash 
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -departments Shapefiles/Buildings.shp
    ```
    
    The '-departments' command also allows specifying the location of a folder containing multiple Shapefiles to integrate. However, ensure that they all have the same data structure (BD-TOPO 2024).
    
2. By default, the program selects buildings within a rectangle containing all points with a margin of 20 meters. With the '-margin' command, you can modify this margin :
    ```bash 
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -departments Shapefiles/Buildings.shp -margin 100
    ```
    
3. The selection of buildings within the extent generates a temporary Shapefile, however, you can save it by specifying a filename with '-save_buildings' :
    ```bash 
    python src/csv_to_kml.py test/EXTEVENT.LOG -it extevent -departments Shapefiles/Buildings.shp -save_buildings Shapefiles/Workfield_buildings.shp
    ```

# Ephemerids

During your measurements, you recorded the observation and navigation RINEX files from your receiver, and with these, we can determine the visible satellites from each point along with their coordinates.
**Note : for now the coordinates aren't saved, but disponible in the code in a numpy array as mat_sat_obs**

1. Provide the path to the observation (or navigation) file to obtain the list of visible satellites at each point in their description with '-rn' :
    ```bash 
    python src/csv_to_kml.py test/20240223.LOG -it log -rn test/rinex/sept054n.24o
    ```
# Help 

If you want information about the commands and their default values, refer to the README or use the command '-h' or '--help' :
```bash 
python src/csv_to_kml.py -h
```
